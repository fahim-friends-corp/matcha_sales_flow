{% extends 'base.html' %}

{% load custom_filters %}

{% block title %}Social Media Search - Rikyu Matcha Sales Flow{% endblock %}

{% block extra_css %}
<style>
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    .loading-content {
        background: white;
        padding: 30px 50px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0d6efd;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .loading-steps {
        text-align: left;
        margin-top: 20px;
        font-size: 14px;
    }
    .loading-steps li {
        margin-bottom: 8px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h4 id="loadingTitle"><i class="bi bi-search"></i> Searching <span id="platformName"></span>...</h4>
        <p class="text-muted mb-2">This may take 10-30 seconds</p>
        <ul class="loading-steps">
            <li><i class="bi bi-clock-history"></i> Running Apify actor...</li>
            <li><i class="bi bi-database"></i> Collecting results...</li>
            <li><i class="bi bi-instagram text-danger"></i> Extracting Instagram handles...</li>
            <li><i class="bi bi-cloud-download"></i> Auto-saving with Instagram...</li>
        </ul>
    </div>
</div>

<div class="row mb-4">
    <div class="col">
        <h1 class="display-6">
            <i class="bi bi-search text-primary"></i> Social Media Search
        </h1>
        <p class="text-muted">Search for café accounts on TikTok and Instagram using Apify.</p>
        <div class="alert alert-success" role="alert">
            <i class="bi bi-check-circle"></i> <strong>All Search Types Supported!</strong>
            <ul class="mb-0 mt-2">
                <li><strong>TikTok:</strong> Profile search ✓</li>
                <li><strong>Instagram:</strong> Profile, Hashtag, and Place search ✓</li>
            </ul>
        </div>
    </div>
</div>

<!-- Search Form -->
<div class="row mb-4">
    <div class="col-md-10">
        <div class="card">
            <div class="card-body">
                <form method="post" id="searchForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="id_platform" class="form-label">{{ form.platform.label }}</label>
                            {{ form.platform }}
                        </div>
                        <div class="col-md-3">
                            <label for="id_search_type" class="form-label">{{ form.search_type.label }}</label>
                            {{ form.search_type }}
                        </div>
                        <div class="col-md-4">
                            <label for="id_query" class="form-label">{{ form.query.label }}</label>
                            {{ form.query }}
                            <small class="form-text text-muted" id="query-help">{{ form.query.help_text }}</small>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" name="search" id="searchBtn" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Search Results -->
{% if results %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i> Search Results ({{ results|length }})
                </h5>
            </div>
            <div class="card-body p-0">
                <form method="post">
                    {% csrf_token %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th width="50">Select</th>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Platform</th>
                                    <th>Instagram</th>
                                    <th>Followers</th>
                                    <th>Profile</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr>
                                    <td class="text-center">
                                        <input type="checkbox" name="selected_accounts" value="{{ forloop.counter0 }}" class="form-check-input">
                                    </td>
                                    <td>
                                        <strong>{{ result.name|default:result.username }}</strong>
                                        {% if result.instagram_handle %}
                                            <br><small class="text-success"><i class="bi bi-instagram"></i> Found in bio</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <code>@{{ result.username }}</code>
                                    </td>
                                    <td>
                                        {% if result.platform == 'tiktok' %}
                                            <i class="bi bi-tiktok"></i> TikTok
                                        {% elif result.platform == 'instagram' %}
                                            <i class="bi bi-instagram text-danger"></i> Instagram
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result.instagram_handle %}
                                            <a href="{{ result.instagram_url }}" target="_blank" class="btn btn-sm btn-outline-success">
                                                <i class="bi bi-instagram"></i> @{{ result.instagram_handle }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted small">Not found</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result.follower_count %}
                                            {{ result.follower_count|floatformat:0 }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ result.profile_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-box-arrow-up-right"></i> View
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-white">
                        <button type="submit" name="save_selected" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Selected Accounts
                        </button>
                        <small class="text-muted ms-3">Select the accounts you want to add to your database.</small>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if error %}
<div class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
</div>
{% endif %}

{% if not results and not error %}
<div class="row">
    <div class="col-md-10">
        <div class="card">
            <div class="card-body">
                <h5><i class="bi bi-lightbulb"></i> Search Examples</h5>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <h6 class="text-primary">Profile Search</h6>
                        <p class="small mb-1"><strong>TikTok:</strong></p>
                        <code class="small">starbucks bluebottle</code>
                        <p class="small mb-1 mt-2"><strong>Instagram:</strong></p>
                        <code class="small">starbucks bluebottle</code>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-success">Hashtag Search</h6>
                        <p class="small mb-1"><strong>TikTok:</strong></p>
                        <code class="small">matchacafe coffeelover</code>
                        <p class="small mb-1 mt-2"><strong>Instagram:</strong></p>
                        <code class="small">tokyocafe matchabar</code>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-warning">Place Search</h6>
                        <p class="small mb-1"><strong>Instagram:</strong></p>
                        <code class="small">Tokyo</code>
                        <p class="small mb-1 mt-2">or</p>
                        <code class="small">Shibuya, Tokyo</code>
                        <p class="small text-muted mt-2"><em>Note: Place search works best on Instagram</em></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Dynamic placeholder and help text based on search type
    document.addEventListener('DOMContentLoaded', function() {
        const searchTypeSelect = document.getElementById('search-type-select');
        const queryInput = document.getElementById('query-input');
        const queryHelp = document.getElementById('query-help');
        const searchForm = document.getElementById('searchForm');
        const searchBtn = document.getElementById('searchBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const platformSelect = document.getElementById('platform-select');
        const platformName = document.getElementById('platformName');
        
        // Dynamic placeholder
        if (searchTypeSelect && queryInput) {
            searchTypeSelect.addEventListener('change', function() {
                const searchType = this.value;
                
                if (searchType === 'profile') {
                    queryInput.placeholder = 'e.g., starbucks bluebottlecoffee';
                    queryHelp.textContent = 'Enter usernames (without @), separated by spaces';
                } else if (searchType === 'hashtag') {
                    queryInput.placeholder = 'e.g., matchacafe tokyocafe';
                    queryHelp.textContent = 'Enter hashtags (without #)';
                } else if (searchType === 'place') {
                    queryInput.placeholder = 'e.g., Tokyo, Shibuya';
                    queryHelp.textContent = 'Enter a location or place name';
                }
            });
        }
        
        // Loading overlay on search
        if (searchForm) {
            searchForm.addEventListener('submit', function(e) {
                // Only show loading for search button, not save button
                if (e.submitter && e.submitter.name === 'search') {
                    // Get platform name
                    const platform = platformSelect ? platformSelect.options[platformSelect.selectedIndex].text : 'Social Media';
                    platformName.textContent = platform;
                    
                    // Show loading overlay
                    loadingOverlay.style.display = 'flex';
                    
                    // Disable search button
                    searchBtn.disabled = true;
                    searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Searching...';
                }
            });
        }
    });
</script>
{% endblock %}




